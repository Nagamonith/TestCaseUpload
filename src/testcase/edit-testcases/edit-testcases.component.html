<app-alert
  [type]="alertType"
  [message]="alertMessage"
  [show]="showAlert"
  [isConfirm]="isConfirmAlert"
  (onConfirm)="handleConfirmDelete()"
  (onCancel)="handleCancelDelete()">
</app-alert>

<!-- <div class="container">
  <h4 class="text-center">Test Case Management</h4> -->

  <!-- Module and Version display -->
<div class="module-info">
  <div class="module-title">
    <strong> TestCases Module:</strong> {{ getModuleName(selectedModule()) }}
  </div>

  <div class="button-group">
    <button class="btn-small-back" (click)="openForm()"><span [innerHTML]="icons.Add"></span> Test Case</button>
    <button class="btn-small-back" (click)="goBack()"><span [innerHTML]="icons.Change"></span> Change Module</button>
    <button class="btn-small-back" (click)="openModuleAttributes()"><span [innerHTML]="icons.Add"></span>Module Attributes</button>
    <button class="btn-small-back" (click)="refreshVersionOptions()" title="Refresh version options"><span [innerHTML]="icons.Refresh"></span> Refresh</button>
  </div>
</div>



  <!-- Filters -->
   <br />
  <div class="filters-container">
    <!-- <label>Search Filters</label> -->
    <div class="filters">
      <div class="filter-group">
        <label>Test Case ID <span [innerHTML]="icons.Filter"></span></label>
        <input
          type="text"
          placeholder="Filter by TestCase ID"
          [ngModel]="filter().testCaseId"
          (ngModelChange)="updateFilter('testCaseId', $event)"
        />
      </div>
      
      <div class="filter-group">
       <label>Use Case </label>
        <input
          type="text"
          placeholder="Filter by Use Case"
          [ngModel]="filter().useCase"
          (ngModelChange)="updateFilter('useCase', $event)"
        />
      </div>
      
      <div class="filter-group">
        <label>Version<span [innerHTML]="icons.Filter"></span></label>
        <select
          [ngModel]="filter().version"
          (ngModelChange)="updateFilter('version', $event)"
        >
          <option value="">All Versions</option>
          <option *ngFor="let version of getUniqueVersions()" [value]="version">
            {{ version }}
          </option>
        </select>
      </div>
    </div>
  </div>

  <!-- Test case table -->
  <div *ngIf="filteredTestCases().length > 0" class="table-container">
    <table class="test-case-table">
      <thead>
        <tr>
          <th>Sl.No</th>
          <th>Version</th>
          <th>Test Case ID</th>
          <th>Use Case</th>
          <th>Scenario</th>
          <th>Steps</th>
          <th>Expected</th>
          
          <!-- Dynamic attribute columns -->
          <th *ngFor="let attrName of getUniqueAttributeNames()">
            {{attrName}}
          </th>
          
          <th>Actions</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let testCase of filteredTestCases(); let i = index">
          <td>{{ i + 1 }}</td>
          <!-- FIXED: Display version correctly using productVersionId -->
          <td>{{ testCase.productVersionId ? getVersionDisplayText(testCase.productVersionId) : (testCase.version || testCase.productVersionName || 'N/A') }}</td>
          <td>{{ testCase.testCaseId }}</td>
          <td class="wrap-text">{{ testCase.useCase }}</td>
          <td class="wrap-text">{{ testCase.scenario }}</td>
          <td class="wrap-text">
            <div *ngFor="let step of testCase.steps; let i = index">
              <strong>{{i+1}}.</strong> {{step.steps}}
            </div>
          </td>
          <td class="wrap-text">
            <div *ngFor="let step of testCase.steps; let i = index">
              <strong>{{i+1}}.</strong> {{step.expectedResult}}
            </div>
          </td>
          
          <!-- Dynamic attribute values -->
          <td *ngFor="let attrName of getUniqueAttributeNames()" class="wrap-text">
            {{getAttributeValue(testCase, attrName) || '-'}}
          </td>
          
          <td class="actions">
            <button class="btn-small" (click)="startEditing(testCase)"><span [innerHTML]="icons.Edit">Edit</span></button>
            <button class="btn-small" (click)="deleteTestCase(testCase.id, $event)"> <span [innerHTML]="icons.Delete">Delete</span></button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- No results message -->
  <div *ngIf="filteredTestCases().length === 0" class="no-results">
    <div *ngIf="testCases().length === 0" class="no-data">
      ⚠️ No test cases found for this module.
      <button (click)="loadTestCases(selectedModule())" class="btn-refresh">Refresh</button>
    </div>
    <div *ngIf="testCases().length > 0 && filteredTestCases().length === 0" class="no-matches">
      No test cases match your filters. Try adjusting your search criteria.
    </div>
  </div>

  <!-- <button class="btn-save" (click)="openForm()">Add New Test Case</button> -->

  <!-- Add/Edit Test Case Form -->
  <div *ngIf="isEditing()" class="form-overlay">
    <form [formGroup]="form" (ngSubmit)="saveTestCase()" class="test-case-form">
      <h3>{{ form.value.id ? 'Edit' : 'Add' }} Test Case</h3>

      <!-- FIXED: Version dropdown using productVersionId -->
     <div class="form-group">
  <label>Version:</label>
  <select 
    formControlName="productVersionId"
    class="form-control">
    <option value="" disabled>Select Version</option>
    <option 
      *ngFor="let version of versionOptions()" 
      [value]="version.id">  <!-- Bind to version.id (GUID) -->
      {{ version.version }} {{ version.isActive ? '(Active)' : '' }}  <!-- Display version string -->
    </option>
  </select>

        <div *ngIf="form.get('productVersionId')?.invalid && (form.get('productVersionId')?.dirty || form.get('productVersionId')?.touched)" 
            class="error-message">
          Version is required
        </div>
      </div>

      <div class="form-group">
        <label>Test Case ID:</label>
        <input type="text" formControlName="testCaseId" required />
        <div *ngIf="form.get('testCaseId')?.invalid && (form.get('testCaseId')?.dirty || form.get('testCaseId')?.touched)" 
            class="error-message">
          <span *ngIf="form.get('testCaseId')?.errors?.['required']">Test Case ID is required</span>
          <span *ngIf="form.get('testCaseId')?.errors?.['pattern']">Must start with TC followed by numbers</span>
        </div>
      </div>

      <div class="form-group">
        <label>Use Case:</label>
        <input type="text" formControlName="useCase" required />
        <div *ngIf="form.get('useCase')?.invalid && (form.get('useCase')?.dirty || form.get('useCase')?.touched)" 
            class="error-message">
          <span *ngIf="form.get('useCase')?.errors?.['required']">Use Case is required</span>
          <span *ngIf="form.get('useCase')?.errors?.['minlength']">Minimum 5 characters required</span>
        </div>
      </div>

      <div class="form-group">
        <label>Scenario:</label>
        <textarea formControlName="scenario" rows="3" required></textarea>
        <div *ngIf="form.get('scenario')?.invalid && (form.get('scenario')?.dirty || form.get('scenario')?.touched)" 
            class="error-message">
          <span *ngIf="form.get('scenario')?.errors?.['required']">Scenario is required</span>
          <span *ngIf="form.get('scenario')?.errors?.['minlength']">Minimum 10 characters required</span>
        </div>
      </div>

      <div class="form-group">
  <label>Steps:</label>
  <div formArrayName="steps">
    <!-- This should render steps in the correct order (0, 1, 2, ...) -->
    <div *ngFor="let step of steps.controls; let i = index" [formGroupName]="i" class="step-item">
      <div class="step-header">
        <span>Step {{i + 1}}</span>
        <button type="button" class="btn-small-danger" (click)="removeStep(i)" *ngIf="steps.length > 1">
          Remove
        </button>
      </div>
      <textarea formControlName="steps" rows="2" placeholder="Step description" required></textarea>
      <div *ngIf="steps.at(i).get('steps')?.invalid && (steps.at(i).get('steps')?.dirty || steps.at(i).get('steps')?.touched)" 
          class="error-message">
        Step description is required
      </div>
      <textarea formControlName="expectedResult" rows="2" placeholder="Expected result" required></textarea>
      <div *ngIf="steps.at(i).get('expectedResult')?.invalid && (steps.at(i).get('expectedResult')?.dirty || steps.at(i).get('expectedResult')?.touched)" 
          class="error-message">
        Expected result is required
      </div>
    </div>
  </div>
  <button type="button" class="btn-small" (click)="addStep()">Add Step</button>
</div>
      <!-- Dynamic Attributes -->
      <div class="attributes-section" *ngIf="moduleAttributes().length > 0">
        <h4>Attributes</h4>
        <div formArrayName="attributes">
          <div *ngFor="let attr of attributes.controls; let i = index" [formGroupName]="i" class="attribute-item">
            <label>{{ moduleAttributes()[i]?.name || 'Attribute' }}</label>
            <input type="hidden" formControlName="key" />
            <textarea formControlName="value" [attr.required]="moduleAttributes()[i]?.isRequired"></textarea>
            <div *ngIf="moduleAttributes()[i]?.isRequired && attributes.at(i).get('value')?.invalid && (attributes.at(i).get('value')?.dirty || attributes.at(i).get('value')?.touched)" 
                class="error-message">
              This attribute is required
            </div>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn" [disabled]="form.invalid"><span [innerHTML]="icons.Save">Save</span> Save</button>
        <button type="button" class="btn-small-danger" (click)="cancelEditing()"><span [innerHTML]="icons.Cancel"></span>Cancel</button>
      </div>
    </form>
  </div>

  <!-- Module Attributes Modal -->
<div *ngIf="showModuleAttributesForm()" class="form-overlay">
  <div class="test-case-form">
    <h3>Manage Module Attributes</h3>
    
    <!-- Loading indicator -->
    <div *ngIf="loading()" class="loading-indicator">
      <p>Processing... Please wait.</p>
    </div>
    
    <!-- Attributes List -->
    <div *ngIf="!currentModuleAttribute() && !loading()">
      <div *ngIf="moduleAttributes().length === 0" class="no-attributes">
        <p>No module attributes found. Create one to get started.</p>
      </div>
      
      <table *ngIf="moduleAttributes().length > 0" class="attributes-table">
       <thead>
  <tr>
    <th>Name</th>
    <th>Key</th>
    <th>Type</th>
    <th>Required</th>
    <th>Actions</th>
  </tr>
</thead>
<tbody>
  <tr *ngFor="let attr of moduleAttributes(); trackBy: trackByAttributeId">
    <td>{{ attr.name }}</td>
    <td><code>{{ attr.key }}</code></td>
    <td>{{ attr.type || 'text' }}</td>
    <td>
      <span class="badge" [class.required]="attr.isRequired" [class.optional]="!attr.isRequired">
        {{ attr.isRequired ? 'Required' : 'Optional' }}
      </span>
    </td>
    <td class="actions">
      <button class="btn-small" (click)="editModuleAttribute(attr)" [disabled]="loading()">Edit</button>
      <button class="btn-small-danger" (click)="deleteModuleAttribute(attr.id)" [disabled]="loading() || !attr.id">Delete</button>
    </td>
  </tr>
</tbody>

      </table>
      
      <div class="form-actions">
        <button 
          class="btn-save" 
          (click)="addModuleAttribute()"
          [disabled]="loading()">
          ➕ Add New Attribute
        </button>
        <button 
          class="btn-small-danger" 
          (click)="closeModuleAttributeForm()"
          [disabled]="loading()">
          Close
        </button>
      </div>
    </div>
    
    <!-- Attribute Form -->
    <div *ngIf="currentModuleAttribute() && !loading()" class="attribute-form">
      <h4>{{ currentModuleAttribute()!.id ? 'Edit' : 'Add' }} Module Attribute</h4>
      
      <div class="form-group">
        <label for="attr-name">Attribute Name: <span class="required">*</span></label>
        <input 
          id="attr-name"
          type="text" 
          [(ngModel)]="currentModuleAttribute()!.name" 
          placeholder="Enter a descriptive name"
          required 
          maxlength="100" />
        <!-- <small class="help-text">This will be displayed as the column header</small> -->
      </div>
      
      <div class="form-group">
        <label for="attr-key">Key (snake_case): <span class="required">*</span></label>
        <input 
          id="attr-key"
          type="text" 
          [(ngModel)]="currentModuleAttribute()!.key" 
          placeholder="e.g., priority_level, test_environment"
          required 
          pattern="^[a-z_][a-z0-9_]*$"
          maxlength="50" />
        <!-- <small class="help-text">Used internally. Use lowercase letters, numbers, and underscores only</small> -->
      </div>
      
      <div class="form-group">
        <label for="attr-type">Type:</label>
        <select id="attr-type" [(ngModel)]="currentModuleAttribute()!.type">
          <option value="text">Text</option>
          <option value="number">Number</option>
          <option value="checkbox">Checkbox</option>
          <option value="date">Date</option>
          <option value="select">Select (Dropdown)</option>
        </select>
      </div>
      
      <div class="form-group" *ngIf="currentModuleAttribute()!.type === 'select'">
        <label for="attr-options">Options:</label>
        <textarea 
          id="attr-options"
          [(ngModel)]="currentModuleAttribute()!.options" 
          placeholder="Enter comma-separated values: Low, Medium, High&#10;Or JSON array: [&quot;Low&quot;, &quot;Medium&quot;, &quot;High&quot;]"
          rows="3"></textarea>
        <small class="help-text">For dropdown options. Use comma-separated values or JSON array format</small>
      </div>
      
      <div class="form-group">
        <label class="checkbox-label">
          <input 
            type="checkbox" 
            [(ngModel)]="currentModuleAttribute()!.isRequired" />
          <span class="checkbox-text">Required field</span>
        </label>
        <small class="help-text">If checked, this field must be filled for each test case</small>
      </div>
      
      <div class="form-actions">
        <button 
          class="btn-save" 
          (click)="saveModuleAttribute()" 
          [disabled]="!currentModuleAttribute()?.name?.trim() || !currentModuleAttribute()?.key?.trim()">
          {{ currentModuleAttribute()!.id ? 'Update' : 'Save' }} Attribute
        </button>
        <button 
          type="button" 
          class="btn-small-danger" 
          (click)="closeModuleAttributeForm()">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>
<!-- </div> -->